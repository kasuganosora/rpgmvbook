# 自动瓦片系统 (Autotile) - 深度解析

## 什么是自动瓦片？

自动瓦片是 RPG Maker 最聪明的设计之一。**问题**：如果你想画一条弯曲的河流，传统方式需要为每个转角单独画一张图。**解决方案**：自动瓦片让一张图自动适应所有相邻情况。

## 实际案例：项目中的 Map001.json

打开 `data/Map001.json`，你会看到这样的数据：

```json
"data": [2844, 2844, 2844, 0, 2844, 2844, 2844, 0, ...]
```

**2844 是什么？** 让我们来解析：

### 瓦片ID的数学原理

```javascript
// 2844 这个数字的含义：
// 
// 1. 首先判断它属于哪个瓦片集
//    2844 >= 2048 且 < 2816?  不，2844 > 2816
//    2844 >= 2816 且 < 4352?  是！所以它是 A2 瓦片（地面自动瓦片）
//
// 2. 解析出"种类"和"形状"
//    kind = (2844 - 2048) / 48 = 16.6... → 取整 = 16
//    shape = (2844 - 2048) % 48 = 4
//    
//    2844 = 2048 + 16 * 48 + 4
//           ↑      ↑       ↑
//         A1起点  第17种   第5种形状
```

### shape = 4 是什么形状？

让我画出所有48种形状（这里只展示关键几种）：

```
形状编号  描述              示意图
────────────────────────────────────────
0        完全孤立          ████████
         (四周都不同)      ████████
                           ████████
                           ████████

4        左上角            ████░░░░
         (只有左上相同)    ████░░░░
                           ░░░░░░░░
                           ░░░░░░░░

47       完全连接          ░░░░░░░░
         (四周都相同)      ░░░░░░░░
                           ░░░░░░░░
                           ░░░░░░░░
```

**█ = 这部分要画出边缘过渡**
**░ = 这部分是纯色填充**

## 自动瓦片是如何绘制的？

### 源图结构

A2瓦片集（如 `Inside_A2.png`）的结构：

```
┌─────────────────────────────────────────────────────┐
│  地面模板1        地面模板2        地面模板3        │
│  ┌────┬────┐     ┌────┬────┐     ┌────┬────┐      │
│  │基础│边缘│     │基础│边缘│     │基础│边缘│      │
│  │ 96 │96px│     │    │    │     │    │    │      │
│  │高  │高  │     │    │    │     │    │    │      │
│  └────┴────┘     └────┴────┘     └────┴────┘      │
│                                                     │
│  地面模板4        地面模板5        地面模板6        │
│  ┌────┬────┐     ┌────┬────┐     ┌────┬────┐      │
│  │    │    │     │    │    │     │    │    │      │
└──┴────┴────┴─────┴────┴────┴─────┴────┴────┴──────┘

每个模板大小: 96×192 像素
  - 上半部分 96×96: 基础填充区域
  - 下半部分 96×96: 边缘过渡区域
```

### 绘制原理：四象限法

**核心思想**：把 48×48 的目标瓦片分成 4 个 24×24 的小块，每个小块从源图的不同位置复制。

```javascript
// 代码位置: rpg_core.js 约 5040 行
Tilemap.prototype._drawAutotile = function(bitmap, tileId, dx, dy) {
    // 步骤1: 确定查找表
    var autotileTable = Tilemap.FLOOR_AUTOTILE_TABLE;  // 地面用地面表
    
    // 步骤2: 解析ID
    var kind = Tilemap.getAutotileKind(tileId);   // 种类: 哪个模板
    var shape = Tilemap.getAutotileShape(tileId); // 形状: 0-47
    
    // 步骤3: 计算源图位置
    // 模板在图集中的列: kind % 8 (0-7)
    // 模板在图集中的行: Math.floor(kind / 8)
    var tx = kind % 8;
    var ty = Math.floor(kind / 8);
    
    // 每个模板占 96×192，计算像素位置
    var bx = tx * 96;
    var by = ty * 192;
    
    // 步骤4: 获取形状表
    var table = autotileTable[shape];  // 形状4的表: [[2,4],[1,4],[2,3],[1,3]]
    
    // 步骤5: 分4个象限绘制
    var w1 = this._tileWidth / 2;   // 24像素
    var h1 = this._tileHeight / 2;  // 24像素
    
    for (var i = 0; i < 4; i++) {
        // table[i] 告诉我们这个象限从源图的哪个位置复制
        var qsx = table[i][0];  // 源图列偏移
        var qsy = table[i][1];  // 源图行偏移
        
        // 计算源图绝对坐标
        var sx = bx + qsx * w1;  // bx + qsx*24
        var sy = by + qsy * h1;  // by + qsy*24
        
        // 计算目标坐标
        var qx = dx + (i % 2) * w1;      // 0或24
        var qy = dy + Math.floor(i / 2) * h1;  // 0或24
        
        // 执行复制
        bitmap.blt(source, sx, sy, w1, h1, qx, qy, w1, h1);
    }
};
```

### 四象限索引详解

```
目标瓦片 (48×48):
┌─────────┬─────────┐
│ 象限 0  │ 象限 1  │   i=0 → 左上
│ (0, 0)  │ (24, 0) │   i=1 → 右上
├─────────┼─────────┤   i=2 → 左下
│ 象限 2  │ 象限 3  │   i=3 → 右下
│ (0, 24) │(24, 24) │
└─────────┴─────────┘
```

### 形状4的绘制过程示例

```javascript
// shape = 4 的查找表:
Tilemap.FLOOR_AUTOTILE_TABLE[4] = [[2,4],[1,4],[2,3],[1,3]]

// 解析：
// 象限0: 从源图 (2*24, 4*24) 复制
// 象限1: 从源图 (1*24, 4*24) 复制
// 象限2: 从源图 (2*24, 3*24) 复制
// 象限3: 从源图 (1*24, 3*24) 复制
```

**可视化理解**：

```
源图模板 (96×192):
         0      24     48     72     96
      ┌──────┬──────┬──────┬──────┐
   0  │      │      │      │      │
 24   │      │      │      │      │  基础区
 48   │      │      │      │      │
 72   │      │      │      │      │
      ├──────┼──────┼──────┼──────┤
 96   │ 角落 │ 边缘 │ 角落 │ 边缘 │
120   │(2,3) │(1,3) │(2,3) │(1,3) │  过渡区
144   │(2,4) │(1,4) │(2,4) │(1,4) │
168   │      │      │      │      │
      └──────┴──────┴──────┴──────┘

shape=4 时，四个象限分别复制:
- 左上象限: (48, 96)  → 角落位置
- 右上象限: (24, 96)  → 边缘位置
- 左下象限: (48, 72)  → 内部位置
- 右下象限: (24, 72)  → 内部位置
```

## 项目实战：分析 Map001 的草地

让我用项目中的实际数据来演示：

```javascript
// Map001.json 中的部分数据
"data": [
    2844, 2844, 2844, 0,   // 位置 (0,0) 的4层
    2844, 2844, 2844, 0,   // 位置 (1,0) 的4层
    2844, 2844, 2844, 0,   // 位置 (2,0) 的4层
    ...
]
```

**位置 (0,0) 的解析**：

```javascript
// Layer 0 (基础层): tileId = 2844
var tileId = 2844;

// 1. 是自动瓦片吗？
Tilemap.isAutotile(2844);  // true (>= 2048)

// 2. 是哪种自动瓦片？
Tilemap.isTileA2(2844);  // true (2816-4351范围)

// 3. 种类和形状
var kind = Math.floor((2844 - 2048) / 48);  // 16
var shape = (2844 - 2048) % 48;              // 4

// 结论：这是 A2 瓦片集的第17种模板，形状是"左上角连接"
```

**为什么是 shape=4？**

```
地图布局:
     x=0   x=1   x=2
   ┌─────┬─────┬─────┐
y=0│2844 │2844 │2844 │  2844=草地
   ├─────┼─────┼─────┤  0=空
y=1│2844 │2844 │2844 │
   └─────┴─────┴─────┘

位置(0,0)的相邻情况:
  - 左边: 越界 (视为不同)
  - 右边: 2844 (相同)
  - 上边: 越界 (视为不同)
  - 下边: 2844 (相同)

相邻编码: 左=0, 右=1, 上=0, 下=1
→ 只有右边和下边相同 → shape=4 (左上角孤立)
```

## 动画水域 (A1) 的工作原理

### 瓦片ID解析

```javascript
// A1 瓦片 (动画水域) 的 ID 结构
// 
// kind = 0: 第一个水域模板 (通常是海洋)
// kind = 1: 第二个水域模板 (通常是深海)
// kind = 2: 第三个水域模板
// ...
// kind = 3: 第一个瀑布

// 每种水域有 3 帧动画 + 1 帧静态
// 动画帧: kind * 4 + 0, kind * 4 + 1, kind * 4 + 2
// 静止帧: kind * 4 + 3
```

### 动画实现

```javascript
// rpg_core.js - Tilemap 更新
Tilemap.prototype.update = function() {
    this._animationCount++;
    
    // 每30帧更新一次动画
    if (this._animationCount >= 30) {
        this._animationCount = 0;
        this._animationFrame++;
        if (this._animationFrame >= 4) {
            this._animationFrame = 0;
        }
        this._updateAnimation();  // 重绘动画瓦片
    }
};

// 动画通过偏移源图位置实现
Tilemap.prototype._drawAutotile = function(bitmap, tileId, dx, dy) {
    // ...
    
    // 动画水域特殊处理
    if (Tilemap.isTileA1(tileId)) {
        var kind = Tilemap.getAutotileKind(tileId);
        
        // 瀑布用 Y 偏移
        if (Tilemap.isWaterfallTile(tileId)) {
            by += this.animationFrame % 3;  // Y坐标动画
        } 
        // 普通水域用 X 偏移
        else {
            bx += this.animationFrame * 96;  // X坐标动画
        }
    }
    
    // ...
};
```

**源图动画布局**：

```
A1 水域源图 (768×576):
┌──────────────────────────────────────────────────────┐
│ 帧0          │ 帧1          │ 帧2          │ 静止    │
│ ┌────┐       │ ┌────┐       │ ┌────┐       │ ┌────┐  │
│ │    │       │ │    │       │ │    │       │ │    │  │
│ │海洋│       │ │海洋│       │ │海洋│       │ │海洋│  │
│ └────┘       │ └────┘       │ └────┘       │ └────┘  │
│              │              │              │         │
│ ┌────┐       │ ┌────┐       │ ┌────┐       │ ┌────┐  │
│ │深海│       │ │深海│       │ │深海│       │ │深海│  │
│ └────┘       │ └────┘       │ └────┘       │ └────┘  │
└──────────────────────────────────────────────────────┘
   0-191px      192-383px     384-575px     576-767px
```

## 常见问题解答

### Q: 为什么我的自动瓦片边缘有缝隙？

**A**: 检查以下几点：
1. 源图尺寸必须正确 (96×192)
2. 边缘过渡区域的像素要对齐
3. 相邻瓦片的种类(kind)必须相同

### Q: 如何在代码中创建自定义自动瓦片？

```javascript
// 假设你想在 (5, 5) 位置放置一个左上角形状的草地
var kind = 16;   // 第17种草地模板
var shape = 4;   // 左上角形状
var tileId = Tilemap.TILE_ID_A1 + kind * 48 + shape;
// tileId = 2048 + 16 * 48 + 4 = 2820

// 设置到地图数据
var index = (0 * mapHeight + 5) * mapWidth + 5;  // Layer 0
$dataMap.data[index] = tileId;
```

### Q: 如何判断两个瓦片是否"相同"？

```javascript
// 用于计算形状的关键函数
Tilemap.isSameAutotileGroup = function(tileID1, tileID2) {
    if (this.isAutotile(tileID1) && this.isAutotile(tileID2)) {
        // 比较种类，忽略形状
        return this.getAutotileKind(tileID1) === this.getAutotileKind(tileID2);
    } else {
        return tileID1 === tileID2;
    }
};

// 示例：
// 2844 (kind=16, shape=4) 和 2850 (kind=16, shape=10) → true
// 2844 (kind=16) 和 2892 (kind=17) → false
```

## 调试技巧

### 可视化瓦片ID

```javascript
// 在游戏中按F8打开控制台，输入：
for (var y = 0; y < $gameMap.height(); y++) {
    var row = '';
    for (var x = 0; x < $gameMap.width(); x++) {
        var tileId = $gameMap.tileId(x, y, 0);
        row += tileId.toString().padStart(5, ' ') + ' ';
    }
    console.log(row);
}

// 输出示例 (Map001):
// 2844 2844 2844    0 2844 2844 2844    0 ...
// 2844 2844 2844    0 2844 2844 2844    0 ...
```

### 检查自动瓦片动画帧

```javascript
// 查看当前动画帧
console.log($gameMap._tilemap._animationFrame);  // 0-3

// 强制设置动画帧（调试用）
$gameMap._tilemap._animationFrame = 2;
$gameMap._tilemap._updateAnimation();
```
